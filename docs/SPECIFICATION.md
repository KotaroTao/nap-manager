# デンタルNAPマネージャー 仕様書

## 1. 概要

### 1.1 プロダクト概要
歯科医院のNAP（Name, Address, Phone）情報を各種WEBサイト間で統一するための管理ツール。
管理者が複数の歯科医院のNAP情報を一元管理し、各サイトでの表記不一致を検出・修正依頼を行う。

### 1.2 ツール名
**デンタルNAPマネージャー**

### 1.3 対象ユーザー
本ツールは管理者専用です。

### 1.4 解決する課題
- 歯科医院のNAP情報がポータルサイト・SNS・求人サイト等で不統一
- 旧名称・旧住所・旧電話番号が残存している
- 複数サイトの情報を手動で確認・修正するのは非効率
- 修正依頼の対応状況が把握しづらい

---

## 2. ユーザー種別

| 種別 | 役割 |
|------|------|
| 管理者 | 全機能へのフルアクセス。医院管理、サイトリスト管理、NAP監視、修正依頼管理 |

※ クライアント向け機能・課金システムは対象外

---

## 3. 主要機能

### 3.1 認証システム

#### 3.1.1 ログイン機能
- メールアドレス + パスワードによる認証
- ログイン試行制限（5回失敗でアカウントロック、30分後解除）
- セッション管理（有効期限: 24時間、リメンバーミー: 30日）

#### 3.1.2 パスワードリセット
- メールアドレス入力によるリセットリンク送信
- リンク有効期限: 1時間
- リセット完了後、全セッション無効化

#### 3.1.3 セキュリティ
- パスワード要件: 8文字以上、英大文字・小文字・数字を含む
- CSRF対策
- セッション固定攻撃対策

---

### 3.2 医院管理

#### 3.2.1 医院情報
複数の歯科医院を登録・管理できる。

| 項目 | 説明 | 必須 |
|------|------|------|
| 医院ID | 自動採番 | - |
| 医院名（正式名称） | 統一したい正式な医院名 | ○ |
| 郵便番号 | 正式な郵便番号 | ○ |
| 住所（正式） | 統一したい正式な住所 | ○ |
| 電話番号（正式） | 統一したい正式な電話番号 | ○ |
| FAX番号 | 正式なFAX番号 | - |
| メールアドレス | 医院のメールアドレス | - |
| 公式サイトURL | 医院の公式サイト | - |
| 備考 | 自由記述 | - |
| 登録日時 | 自動記録 | - |
| 更新日時 | 自動記録 | - |

#### 3.2.2 旧NAP情報（バリエーション）
1つの医院に対して複数の旧NAP情報を登録可能。

| 項目 | 説明 |
|------|------|
| 旧医院名 | 過去に使用していた名称、表記ゆれ |
| 旧住所 | 過去の住所、表記ゆれ |
| 旧電話番号 | 過去の電話番号 |
| 備考 | この表記が使われていた理由・時期など |

**用途**: サイト上でこれらの旧情報が検出された場合、「不一致」としてアラートを出す。

---

### 3.3 サイトリスト管理

各医院のNAP情報が掲載される可能性のあるサイトを管理する。

#### 3.3.1 サイト種別（3種類）

| 種別 | 説明 | 編集権限 |
|------|------|----------|
| マスタサイト | 管理者が事前登録する標準サイト | 管理者のみ |
| 自動追加 | WEB検索で自動発見されたサイト | 管理者 |
| 手動追加 | 管理者が個別に追加したサイト | 管理者 |

#### 3.3.2 サイト情報項目

| 項目 | 説明 | 必須 |
|------|------|------|
| サイト名 | サイトの名称（例: Google ビジネスプロフィール） | ○ |
| サイトURL | サイトのトップページURL | ○ |
| 新規登録URL | 医院情報を新規登録するページのURL | - |
| 修正依頼URL | 医院情報を修正依頼するページのURL | - |
| 種別① | 有料 / 無料 / 承認制 | ○ |
| 種別② | SNS / ポータルサイト / 求人サイト / その他 | ○ |
| 変更依頼方法 | フォーム / メール / 電話 / その他 | ○ |
| コメント | 自由記述（注意事項、手順メモなど） | - |
| 有効/無効 | サイトの監視対象フラグ | ○ |
| 登録日時 | 自動記録 | - |
| 更新日時 | 自動記録 | - |

#### 3.3.3 マスタサイト一覧（初期登録例）

| カテゴリ | サイト例 |
|----------|----------|
| 検索エンジン | Google ビジネスプロフィール, Yahoo!プレイス |
| ポータルサイト | EPARK歯科, 歯科タウン, デンターネット, Caloo |
| 地図サービス | Googleマップ, Yahoo!地図, Apple Maps |
| SNS | Facebook, Instagram, X (Twitter), LINE公式 |
| 求人サイト | ジョブメドレー, グッピー, Indeed |
| 口コミサイト | Google口コミ, エキテン |
| その他 | 日本歯科医師会HP, 各都道府県歯科医師会HP |

---

### 3.4 医院別サイト紐付け（NAP監視対象）

各医院とサイトを紐付け、NAP情報の一致状況を管理する。

#### 3.4.1 紐付け情報

| 項目 | 説明 |
|------|------|
| 医院ID | 対象医院 |
| サイトID | 対象サイト |
| 掲載ページURL | 当該医院の情報が掲載されているページのURL |
| ステータス | 一致 / 要確認 / 不一致 / 未チェック / アクセス不可 |
| 検出NAP | サイトから取得したNAP情報 |
| 最終チェック日時 | 最後にNAPをチェックした日時 |
| 備考 | 自由記述 |

#### 3.4.2 ステータス定義

| ステータス | 説明 | 表示色 |
|------------|------|--------|
| 一致 | 正式NAPと完全一致 | 緑 |
| 要確認 | 軽微な差異あり（表記ゆれ程度） | 黄 |
| 不一致 | 明確な不一致（旧情報等） | 赤 |
| 未チェック | まだチェックしていない | グレー |
| アクセス不可 | ページにアクセスできない | 黒 |

---

### 3.5 NAP不一致アラート

#### 3.5.1 ダッシュボード表示
- 不一致件数をバッジで表示
- 要対応サイト一覧をカード形式で表示
- 医院別の不一致率グラフ

#### 3.5.2 メール通知
- 新規不一致検出時（即時）
- 週次サマリー（毎週月曜9:00）
- 通知設定でON/OFF可能

#### 3.5.3 通知設定項目

| 項目 | 説明 | デフォルト |
|------|------|------------|
| 新規不一致通知 | 新しい不一致検出時に通知 | ON |
| 週次サマリー | 週次レポートをメール送信 | ON |
| アクセス不可通知 | サイトにアクセスできない場合に通知 | OFF |

---

### 3.6 修正依頼管理

#### 3.6.1 修正依頼テンプレート自動生成
不一致を検出したサイトに対して、修正依頼文を自動生成する。

**テンプレート項目:**
- 宛先（サイト名）
- 件名
- 本文（現在の掲載情報 → 正しい情報）
- 依頼者情報

#### 3.6.2 対応状況トラッキング

| ステータス | 説明 |
|------------|------|
| 未対応 | 修正依頼を送信していない |
| 依頼済み | 修正依頼を送信した |
| 対応中 | 先方で対応中 |
| 完了 | 修正が完了した |
| 対応不可 | 先方の都合で対応できない |

#### 3.6.3 修正依頼履歴
- 依頼日時
- 依頼方法（フォーム/メール/電話）
- 担当者メモ
- 添付ファイル（スクリーンショット等）

---

## 4. 画面一覧

### 4.1 認証系画面

| 画面名 | パス | 説明 |
|--------|------|------|
| ログイン | /login | 管理者ログイン |
| パスワードリセット | /password-reset | パスワード再設定 |
| パスワード再設定 | /password-reset/:token | 新パスワード入力 |

### 4.2 メイン画面

| 画面名 | パス | 説明 |
|--------|------|------|
| ダッシュボード | /dashboard | 全体サマリー、アラート表示 |
| 医院一覧 | /clinics | 登録医院の一覧 |
| 医院詳細 | /clinics/:id | 医院情報の詳細・編集 |
| 医院登録 | /clinics/new | 新規医院登録 |
| サイト一覧 | /sites | マスタサイト一覧 |
| サイト詳細 | /sites/:id | サイト情報の詳細・編集 |
| サイト登録 | /sites/new | 新規サイト登録 |
| NAP監視一覧 | /monitoring | 医院別サイト紐付け・ステータス一覧 |
| NAP監視詳細 | /monitoring/:id | 個別のNAP監視詳細 |
| 修正依頼一覧 | /requests | 修正依頼の一覧 |
| 修正依頼詳細 | /requests/:id | 修正依頼の詳細・履歴 |
| 設定 | /settings | 通知設定、アカウント設定 |

---

## 5. データモデル

### 5.1 ER図（概念）

```
┌─────────────┐       ┌─────────────┐
│   Admins    │       │   Clinics   │
├─────────────┤       ├─────────────┤
│ id          │       │ id          │
│ email       │       │ name        │
│ password    │       │ postal_code │
│ created_at  │       │ address     │
│ updated_at  │       │ phone       │
└─────────────┘       │ fax         │
                      │ email       │
                      │ website     │
                      │ notes       │
                      │ created_at  │
                      │ updated_at  │
                      └──────┬──────┘
                             │
                             │ 1:N
                             ▼
                      ┌─────────────┐
                      │ ClinicNAPs  │
                      │ (旧NAP情報) │
                      ├─────────────┤
                      │ id          │
                      │ clinic_id   │
                      │ old_name    │
                      │ old_address │
                      │ old_phone   │
                      │ notes       │
                      │ created_at  │
                      └─────────────┘

┌─────────────┐
│   Sites     │
├─────────────┤
│ id          │
│ name        │
│ url         │
│ register_url│
│ edit_url    │
│ type_1      │  (有料/無料/承認制)
│ type_2      │  (SNS/ポータル/求人/他)
│ edit_method │  (フォーム/メール/電話/他)
│ comment     │
│ site_type   │  (master/auto/manual)
│ is_active   │
│ created_at  │
│ updated_at  │
└──────┬──────┘
       │
       │ N:M (through ClinicSites)
       ▼
┌─────────────────┐
│  ClinicSites    │
│ (医院別紐付け)  │
├─────────────────┤
│ id              │
│ clinic_id       │
│ site_id         │
│ page_url        │
│ status          │
│ detected_name   │
│ detected_address│
│ detected_phone  │
│ last_checked_at │
│ notes           │
│ created_at      │
│ updated_at      │
└────────┬────────┘
         │
         │ 1:N
         ▼
┌─────────────────┐
│ CorrectionReqs  │
│ (修正依頼)      │
├─────────────────┤
│ id              │
│ clinic_site_id  │
│ status          │
│ request_method  │
│ template_text   │
│ notes           │
│ created_at      │
│ updated_at      │
└────────┬────────┘
         │
         │ 1:N
         ▼
┌─────────────────┐
│ RequestHistory  │
│ (依頼履歴)      │
├─────────────────┤
│ id              │
│ correction_id   │
│ action          │
│ notes           │
│ attachment_url  │
│ created_at      │
└─────────────────┘

┌─────────────────┐
│ Notifications   │
│ (通知設定)      │
├─────────────────┤
│ id              │
│ admin_id        │
│ type            │
│ is_enabled      │
│ created_at      │
│ updated_at      │
└─────────────────┘
```

### 5.2 テーブル定義

#### 5.2.1 admins（管理者）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| email | VARCHAR(255) | メールアドレス（ユニーク） |
| password_hash | VARCHAR(255) | パスワードハッシュ |
| name | VARCHAR(100) | 管理者名 |
| failed_login_attempts | INTEGER | ログイン失敗回数 |
| locked_until | TIMESTAMP | ロック解除日時 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.2 clinics（医院）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(200) | 正式医院名 |
| postal_code | VARCHAR(10) | 郵便番号 |
| address | VARCHAR(500) | 正式住所 |
| phone | VARCHAR(20) | 正式電話番号 |
| fax | VARCHAR(20) | FAX番号 |
| email | VARCHAR(255) | メールアドレス |
| website | VARCHAR(500) | 公式サイトURL |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.3 clinic_naps（旧NAP情報）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | 医院ID（外部キー） |
| old_name | VARCHAR(200) | 旧医院名 |
| old_address | VARCHAR(500) | 旧住所 |
| old_phone | VARCHAR(20) | 旧電話番号 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |

#### 5.2.4 sites（サイト）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(200) | サイト名 |
| url | VARCHAR(500) | サイトURL |
| register_url | VARCHAR(500) | 新規登録URL |
| edit_url | VARCHAR(500) | 修正依頼URL |
| type_1 | ENUM | 有料/無料/承認制 |
| type_2 | ENUM | SNS/ポータルサイト/求人サイト/その他 |
| edit_method | ENUM | フォーム/メール/電話/その他 |
| comment | TEXT | コメント |
| site_type | ENUM | master/auto/manual |
| is_active | BOOLEAN | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.5 clinic_sites（医院別サイト紐付け）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | 医院ID（外部キー） |
| site_id | UUID | サイトID（外部キー） |
| page_url | VARCHAR(500) | 掲載ページURL |
| status | ENUM | 一致/要確認/不一致/未チェック/アクセス不可 |
| detected_name | VARCHAR(200) | 検出された医院名 |
| detected_address | VARCHAR(500) | 検出された住所 |
| detected_phone | VARCHAR(20) | 検出された電話番号 |
| last_checked_at | TIMESTAMP | 最終チェック日時 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.6 correction_requests（修正依頼）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_site_id | UUID | 医院サイト紐付けID（外部キー） |
| status | ENUM | 未対応/依頼済み/対応中/完了/対応不可 |
| request_method | ENUM | フォーム/メール/電話 |
| template_text | TEXT | 依頼テンプレート文 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.7 request_histories（依頼履歴）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| correction_request_id | UUID | 修正依頼ID（外部キー） |
| action | VARCHAR(100) | アクション内容 |
| notes | TEXT | メモ |
| attachment_url | VARCHAR(500) | 添付ファイルURL |
| created_at | TIMESTAMP | 作成日時 |

#### 5.2.8 notification_settings（通知設定）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| admin_id | UUID | 管理者ID（外部キー） |
| new_mismatch | BOOLEAN | 新規不一致通知 |
| weekly_summary | BOOLEAN | 週次サマリー |
| access_error | BOOLEAN | アクセス不可通知 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

---

## 6. 技術スタック（案）

### 6.1 フロントエンド
| 技術 | 用途 |
|------|------|
| Next.js 14 | Reactフレームワーク |
| TypeScript | 型安全な開発 |
| Tailwind CSS | スタイリング |
| shadcn/ui | UIコンポーネント |
| React Hook Form | フォーム管理 |
| Zod | バリデーション |
| TanStack Query | データフェッチング |

### 6.2 バックエンド
| 技術 | 用途 |
|------|------|
| Next.js API Routes | APIエンドポイント |
| Prisma | ORM |
| PostgreSQL | データベース |
| NextAuth.js | 認証 |
| Resend | メール送信 |

### 6.3 インフラ
| 技術 | 用途 |
|------|------|
| Vercel | ホスティング |
| Supabase | PostgreSQL + Auth |
| Cloudflare R2 | ファイルストレージ |

---

## 7. 非機能要件

### 7.1 セキュリティ
- HTTPS必須
- パスワードはbcryptでハッシュ化
- SQLインジェクション対策（Prisma使用）
- XSS対策（React + CSP）
- CSRF対策（NextAuth.js）

### 7.2 パフォーマンス
- ページ読み込み: 3秒以内
- API応答: 500ms以内

### 7.3 可用性
- 稼働率: 99.5%以上
- データバックアップ: 日次

### 7.4 ブラウザ対応
- Chrome（最新2バージョン）
- Firefox（最新2バージョン）
- Safari（最新2バージョン）
- Edge（最新2バージョン）

---

## 8. 今後の拡張候補

以下は本フェーズでは対象外だが、将来的に検討する機能：

1. **NAP自動チェック機能** - 定期的にサイトをクロールしてNAP情報を自動取得
2. **WEB検索による自動サイト発見** - 医院名で検索して掲載サイトを自動発見
3. **API連携** - Google ビジネスプロフィールAPI等との連携
4. **レポート機能** - PDF形式でのNAP統一状況レポート出力
5. **複数管理者対応** - 権限レベルを持つ複数管理者

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| NAP | Name, Address, Phone の略。事業者の基本情報 |
| 正式NAP | 統一すべき正しいNAP情報 |
| 旧NAP | 過去に使用していたNAP情報、表記ゆれ |
| マスタサイト | 管理者が事前登録する標準的な監視対象サイト |
| 不一致 | サイト上のNAPが正式NAPと異なる状態 |
| 表記ゆれ | 同じ情報の異なる表記（例: 「1丁目」と「1-」） |

---

## 10. 改訂履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 0.1 | 2025-12-25 | 初版作成 |
