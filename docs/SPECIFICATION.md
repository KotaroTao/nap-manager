# デンタルNAPマネージャー 仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**デンタルNAPマネージャー**（Dental NAP Manager）

### 1.2 目的
歯科医院のNAP（Name, Address, Phone）情報をWEB上で統一管理し、各種サイトでの表記揺れを検出・是正することで、MEO（Map Engine Optimization）効果を最大化するWEBツール。

### 1.3 NAP統一の重要性
- Googleマップ等の検索エンジンは、NAP情報の一貫性を信頼性の指標として評価
- 表記揺れ（例：「歯科」vs「デンタル」、番地表記の違い等）があるとSEO/MEO評価が下がる
- 手動での監視は非効率であり、自動化が必要

### 1.4 主要ユーザー
- 歯科医院経営者・スタッフ
- 歯科医院のWEBマーケティング担当者
- MEO対策を請け負う代理店

---

## 2. ユーザー種別と権限

### 2.1 ユーザー種別

| 種別 | 説明 |
|------|------|
| **管理者（Admin）** | システム全体を管理。マスタサイト管理、クライアント管理、課金プラン設定を行う |
| **クライアント（Client）** | 医院情報の登録・管理、サイトリストの管理、アラートの確認を行う |

### 2.2 権限マトリクス

| 機能 | 管理者 | クライアント |
|------|:------:|:------------:|
| ダッシュボード閲覧 | ○ | ○（自院のみ） |
| マスタサイト登録・編集 | ○ | × |
| マスタサイト閲覧 | ○ | ○ |
| 自動追加サイト編集 | ○ | ○（自院のみ） |
| 手動サイト登録・編集 | ○ | ○（自院のみ） |
| 医院情報登録・編集 | ○ | ○（自院のみ） |
| クライアント管理 | ○ | × |
| 課金プラン設定 | ○ | × |
| 通知設定 | ○ | ○（自身のみ） |
| アラート確認 | ○ | ○（自院のみ） |
| 修正依頼テンプレート利用 | ○ | ○ |

---

## 3. 機能詳細

### 3.1 認証システム

#### 3.1.1 新規登録
- **登録方法**: メールアドレス認証
- **必要情報**:
  - メールアドレス（必須、ユニーク）
  - パスワード（必須、8文字以上、英数字記号混在推奨）
  - 医院名（クライアントの場合、必須）
  - 氏名（必須）
  - 電話番号（任意）
- **フロー**:
  1. 登録フォーム入力
  2. 確認メール送信（認証リンク付き）
  3. リンククリックで本登録完了
  4. 14日間無料トライアル開始

#### 3.1.2 ログイン
- **方式**: メールアドレス + パスワード
- **セッション管理**:
  - セッション有効期間: 24時間
  - 「ログイン状態を維持」選択時: 30日間
  - 同時ログイン: 許可（複数デバイス対応）

#### 3.1.3 パスワードリセット
- **フロー**:
  1. パスワードリセット申請（メールアドレス入力）
  2. リセットリンク付きメール送信
  3. リンク有効期限: 24時間
  4. 新パスワード設定

#### 3.1.4 二要素認証（将来拡張）
- TOTP（Google Authenticator等）対応を将来的に検討

---

### 3.2 医院情報管理

#### 3.2.1 基本構造
1つのクライアントアカウントで**複数医院**を管理可能。

#### 3.2.2 医院情報の構成

**正式NAP（統一したい表記）**
| 項目 | 説明 | 例 |
|------|------|------|
| 医院名 | 正式名称 | さくら歯科クリニック |
| 郵便番号 | 7桁ハイフンあり | 〒123-4567 |
| 都道府県 | 選択式 | 東京都 |
| 市区町村 | テキスト | 渋谷区 |
| 番地 | テキスト | 1-2-3 |
| 建物名・階 | テキスト（任意） | ABCビル 3F |
| 電話番号 | ハイフン区切り | 03-1234-5678 |
| FAX番号 | ハイフン区切り（任意） | 03-1234-5679 |
| メールアドレス | 公開用 | info@sakura-dental.jp |
| WEBサイトURL | 公式サイト | https://sakura-dental.jp |

**現在のNAP（旧名称等、複数登録可）**
- 旧医院名やよくある表記揺れを登録
- 例: 「さくらデンタルクリニック」「桜歯科」等
- これらも「一致」として扱うかどうかを設定可能

#### 3.2.3 医院管理機能
- 医院の追加・編集・削除
- 医院ごとのサイトリスト管理
- 医院ごとのダッシュボード表示

---

### 3.3 サイトリスト管理

#### 3.3.1 サイトの種類

| 種類 | 登録者 | クライアント編集 | 説明 |
|------|--------|------------------|------|
| **マスタサイト** | 管理者 | × | 全クライアント共通の監視対象サイト。管理者のみ登録・編集可 |
| **自動追加サイト** | システム | ○ | WEB検索で自動発見されたサイト。クライアントが確認・編集可 |
| **手動追加サイト** | クライアント | ○ | クライアントが個別に登録したサイト |

#### 3.3.2 マスタサイト
**登録情報**

| 項目 | 説明 | 例 |
|------|------|------|
| サイト名 | サイトの名称 | エキテン |
| サイトURL | サイトのトップページURL | https://www.ekiten.jp |
| 新規登録URL | 医院情報を新規登録するページ | https://www.ekiten.jp/register |
| 修正依頼URL | 情報修正を依頼するページ | https://www.ekiten.jp/contact |
| 種別① | 料金体系 | 有料/無料/承認制 |
| 種別② | サイト分類 | SNS/ポータルサイト/求人サイト/その他 |
| 変更依頼方法 | 修正依頼の方法 | フォーム/メール/電話/その他 |
| コメント | 補足情報・注意事項 | 修正反映まで3営業日程度 |
| スクレイピング設定 | NAP抽出ルール（JSONB） | - |
| 優先度 | 監視の優先度 | 高/中/低 |
| チェック頻度 | NAP確認の頻度 | 日次/週次/月次 |

**種別①の値**
- `free`: 無料
- `paid`: 有料
- `approval`: 承認制

**種別②の値**
- `sns`: SNS
- `portal`: ポータルサイト
- `job`: 求人サイト
- `other`: その他

**変更依頼方法の値**
- `form`: WEBフォーム
- `email`: メール
- `phone`: 電話
- `other`: その他

**初期マスタサイト例**
- Googleマップ（Googleビジネスプロフィール）
- Yahoo!ロコ
- エキテン
- EPARK歯科
- デンターネット
- 歯科タウン
- Caloo
- 病院なび
- マイクリニック
- Instagram
- Facebook
- Indeed
- ジョブメドレー

#### 3.3.3 自動追加サイト
**発見方法**
- 医院名 + 「歯科」等のキーワードでWEB検索
- 検索結果から医院情報が掲載されているサイトを抽出
- 既存サイトリストと重複チェック後、新規サイトとして追加

**ステータス**
- 未確認: 自動追加直後
- 確認済み: クライアントが内容確認済み
- 除外: 監視対象外としてマーク

#### 3.3.4 手動追加サイト
**登録情報**
- サイト名
- URL（医院情報が掲載されているページのURL）
- メモ（任意）

#### 3.3.5 サイト共通情報
- 最終チェック日時
- NAP一致ステータス
- 検出されたNAP情報（名称、住所、電話番号）
- 履歴（変更検出時）

---

### 3.4 NAP不一致アラート

#### 3.4.1 ステータス定義

| ステータス | 説明 | 表示色 |
|------------|------|--------|
| **一致** | 正式NAPと完全一致、または許容範囲内 | 緑 |
| **要確認** | 軽微な差異あり（句読点、スペース等） | 黄 |
| **不一致** | 明確な差異あり（修正推奨） | 赤 |
| **未チェック** | まだチェックが実行されていない | グレー |
| **アクセス不可** | サイトにアクセスできない、または情報が見つからない | オレンジ |

#### 3.4.2 一致判定ロジック
**完全一致として扱うケース**
- 全項目が正式NAPと完全一致
- 「現在のNAP」として登録された表記と一致

**要確認として扱うケース**
- 全角/半角の違い
- スペースの有無
- 「丁目」「番地」等の表記差異
- ハイフンの種類（-、ー、―等）

**不一致として扱うケース**
- 医院名の異なる表記
- 住所の番地違い
- 電話番号の違い

#### 3.4.3 アラート表示

**ダッシュボード**
- 不一致件数のバナー表示（赤背景）
- 要確認件数のバッジ表示（黄背景）
- サイト別ステータス一覧

**メール通知**
- 新規不一致検出時（即座に通知）
- 週次サマリー（毎週月曜朝）
- 月次レポート（毎月1日）

#### 3.4.4 通知設定（クライアント個別）
- 即時通知: ON/OFF
- 週次サマリー: ON/OFF
- 月次レポート: ON/OFF
- 通知先メールアドレス（複数登録可）

---

### 3.5 修正依頼機能

#### 3.5.1 修正依頼テンプレート
サイト種別ごとに最適化されたテンプレートを自動生成。

**テンプレート例（口コミサイト向け）**
```
件名: 【修正依頼】○○歯科クリニック 掲載情報の訂正のお願い

○○サイト ご担当者様

お世話になっております。
○○歯科クリニックの担当△△と申します。

貴サイトに掲載いただいている当院の情報につきまして、
下記の通り訂正をお願いしたくご連絡いたしました。

■ 現在の掲載情報
医院名: [検出された医院名]
住所: [検出された住所]
電話番号: [検出された電話番号]

■ 正しい情報
医院名: [正式医院名]
住所: [正式住所]
電話番号: [正式電話番号]

お手数をおかけいたしますが、ご対応のほど
よろしくお願いいたします。

○○歯科クリニック
担当: △△
連絡先: XXX-XXXX-XXXX
```

#### 3.5.2 対応状況トラッキング

| ステータス | 説明 |
|------------|------|
| 未対応 | 修正依頼未送信 |
| 依頼中 | 修正依頼送信済み、返答待ち |
| 対応中 | サイト側で修正作業中 |
| 完了 | 修正確認済み |
| 対応不可 | サイト側で修正不可と回答 |

#### 3.5.3 リマインダー
- 依頼後7日間返答がない場合、リマインダー通知
- 依頼後14日間変化がない場合、再送信提案

---

### 3.6 Stripe課金システム

#### 3.6.1 プラン構成

| プラン | 月額（税抜） | 医院数 | マスタサイト監視 | 自動追加サイト | 手動追加サイト | チェック頻度 |
|--------|-------------|--------|------------------|----------------|----------------|--------------|
| **ライト** | ¥2,980 | 1医院 | 上位10サイト | 最大20件 | 最大10件 | 週次 |
| **スタンダード** | ¥5,980 | 3医院 | 全サイト | 最大50件/医院 | 最大30件/医院 | 日次 |
| **エンタープライズ** | ¥14,800 | 10医院 | 全サイト | 無制限 | 無制限 | 日次＋即時 |

#### 3.6.2 無料トライアル
- 期間: 14日間
- 機能: スタンダードプラン相当
- クレジットカード登録: 不要（トライアル開始時）
- トライアル終了3日前にメール通知
- トライアル終了後、プラン選択画面へ誘導

#### 3.6.3 Stripe機能
**Customer Portal**
- プラン変更
- 支払い方法変更
- 請求書ダウンロード
- 解約手続き

**Webhook対応イベント**
- checkout.session.completed（新規契約）
- customer.subscription.updated（プラン変更）
- customer.subscription.deleted（解約）
- invoice.payment_failed（支払い失敗）
- invoice.payment_succeeded（支払い成功）

#### 3.6.4 支払い失敗時の対応
- 即座にメール通知
- 3日間の猶予期間
- 猶予期間後、アカウント一時停止（読み取り専用）
- 14日間支払いがない場合、データ保持のみ（機能停止）

---

## 4. 非機能要件

### 4.1 パフォーマンス
- ページロード時間: 3秒以内
- API レスポンス時間: 500ms以内（95パーセンタイル）
- 同時接続数: 1000ユーザー以上対応

### 4.2 可用性
- 稼働率: 99.5%以上
- 計画メンテナンス: 月1回、深夜帯（2:00-5:00）

### 4.3 セキュリティ
- HTTPS必須
- パスワードハッシュ化（bcrypt）
- SQLインジェクション対策
- XSS対策
- CSRF対策
- レートリミッティング

### 4.4 データ保持
- アクティブアカウント: 無期限
- 解約アカウント: 30日後にデータ削除
- ログ: 90日間保持

### 4.5 バックアップ
- データベース: 日次バックアップ
- 保持期間: 30日間
- リストア: 4時間以内

---

## 5. 技術スタック（推奨）

### 5.1 フロントエンド
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: shadcn/ui
- **状態管理**: Zustand または React Query
- **フォーム**: React Hook Form + Zod

### 5.2 バックエンド
- **フレームワーク**: Next.js API Routes または別途 Express/Fastify
- **言語**: TypeScript
- **ORM**: Prisma
- **認証**: NextAuth.js または Clerk
- **バリデーション**: Zod

### 5.3 データベース
- **メイン**: PostgreSQL
- **キャッシュ**: Redis（セッション、レートリミット用）

### 5.4 インフラ
- **ホスティング**: Vercel または AWS
- **データベース**: Supabase または PlanetScale
- **ファイルストレージ**: AWS S3 または Cloudflare R2

### 5.5 外部サービス
- **決済**: Stripe
- **メール**: SendGrid または Resend
- **監視**: Sentry
- **分析**: Google Analytics または Plausible

### 5.6 スクレイピング/検索
- **WEB検索API**: Google Custom Search API または SerpApi
- **スクレイピング**: Puppeteer または Playwright（必要に応じて）

---

## 6. 追加機能提案（将来拡張）

以下は将来的に追加を検討する機能です。

### 6.1 一括チェック機能
- 全サイトまたは選択したサイトを一括でNAPチェック
- 進捗状況をリアルタイム表示
- チェック完了後にサマリーレポートを表示

### 6.2 レポートPDF出力
- 月次/週次レポートをPDF形式でダウンロード
- 経営層への報告用にカスタマイズ可能
- 医院ロゴの挿入対応

### 6.3 サイト登録代行機能
- 未登録サイトへの新規登録を代行依頼
- 登録代行の進捗管理
- 必要書類のアップロード機能

### 6.4 チーム機能
- 1アカウントに複数スタッフを招待
- スタッフごとの権限設定（閲覧のみ/編集可/管理者）
- 操作ログの記録

### 6.5 競合医院モニタリング
- 競合医院のNAP情報も監視
- 自院との掲載状況比較
- 競合が掲載されているサイトへの新規登録提案

### 6.6 変更履歴タイムライン
- NAP情報の変更履歴を時系列で表示
- 各サイトでの変更検出履歴
- 対応状況との紐付け

### 6.7 優先度スコアリング
- 各サイトのSEO影響度をスコア化
- 対応優先順位の自動提案
- 修正効果の予測

### 6.8 GoogleビジネスプロフィールAPI連携
- Googleビジネスプロフィールへの直接アクセス
- NAP情報の自動同期
- 投稿・写真の管理

### 6.9 Slack/Chatwork連携
- アラート通知をSlack/Chatworkに送信
- 対応状況の共有
- コマンドによるステータス確認

### 6.10 CSVインポート/エクスポート
- 医院情報の一括インポート
- サイトリストのエクスポート
- チェック結果のデータ出力

---

## 7. 開発フェーズ（参考）

### Phase 1: MVP（最小実用製品）
- 認証システム（登録、ログイン、パスワードリセット）
- 医院情報管理（1医院のみ）
- マスタサイト管理（管理者）
- 手動サイト追加（クライアント）
- NAP一致チェック（基本ロジック）
- ダッシュボード（基本表示）

### Phase 2: コア機能拡張
- 複数医院対応
- 自動サイト発見機能
- 詳細な一致判定ロジック
- アラート・通知システム
- Stripe課金統合

### Phase 3: 高度な機能
- 修正依頼テンプレート
- 対応状況トラッキング
- 詳細レポート・分析
- API提供（外部連携用）

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| NAP | Name, Address, Phone の略。店舗・施設の基本情報 |
| MEO | Map Engine Optimization。地図検索での上位表示施策 |
| マスタサイト | 全クライアント共通で監視する重要サイト |
| 自動追加サイト | システムが自動発見した医院情報掲載サイト |
| 表記揺れ | 同じ情報の異なる表記（例：「1丁目」vs「1-」） |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 1.0.0 | 2024-XX-XX | 初版作成 |
| 1.1.0 | 2024-XX-XX | サイトリスト項目追加、追加機能提案追加、ログイン試行制限削除 |
