# デンタルNAPマネージャー 仕様書

## 1. 概要

### 1.1 プロダクト概要
歯科医院のNAP（Name, Address, Phone）情報を各種WEBサイト間で統一するための管理ツール。
管理者が複数の歯科医院のNAP情報を一元管理し、各サイトでの表記不一致を検出・修正依頼を効率的に行う。

### 1.2 ツール名
**デンタルNAPマネージャー**

### 1.3 対象ユーザー
本ツールは管理者専用です。

### 1.4 解決する課題
- 歯科医院のNAP情報がポータルサイト・SNS・求人サイト等で不統一
- 旧名称・旧住所・旧電話番号が残存している
- 複数サイトの情報を手動で確認・修正するのは非効率
- 修正依頼の対応状況が把握しづらい
- どのサイトから対応すべきか優先順位が不明確

### 1.5 コア設計思想：徹底的な効率化

本ツールは以下の原則に基づき設計する：

1. **最小クリック原則** - あらゆる操作を最小限のクリックで完結
2. **コンテキスト維持** - 画面遷移を減らし、モーダル・サイドパネルを活用
3. **一括処理優先** - 繰り返し作業は必ず一括処理を提供
4. **コピー&ペースト最適化** - 外部サイトへの入力を想定した即コピー機能
5. **次アクション提示** - 常に「次にやるべきこと」を明示

---

## 2. ユーザー種別

| 種別 | 役割 |
|------|------|
| 管理者 | 全機能へのフルアクセス。医院管理、サイトリスト管理、NAP監視、修正依頼管理 |

※ クライアント向け機能・課金システムは対象外

---

## 3. 主要機能

### 3.1 認証システム

#### 3.1.1 ログイン機能
- メールアドレス + パスワードによる認証
- ログイン試行制限（5回失敗でアカウントロック、30分後解除）
- セッション管理（有効期限: 24時間、リメンバーミー: 30日）

#### 3.1.2 パスワードリセット
- メールアドレス入力によるリセットリンク送信
- リンク有効期限: 1時間
- リセット完了後、全セッション無効化

#### 3.1.3 セキュリティ
- パスワード要件: 8文字以上、英大文字・小文字・数字を含む
- CSRF対策
- セッション固定攻撃対策

---

### 3.2 医院管理

#### 3.2.1 医院情報
複数の歯科医院を登録・管理できる。

| 項目 | 説明 | 必須 |
|------|------|------|
| 医院ID | 自動採番 | - |
| 医院名（正式名称） | 統一したい正式な医院名 | ○ |
| 医院名（かな） | ふりがな | - |
| 郵便番号 | 正式な郵便番号 | ○ |
| 都道府県 | 正式な都道府県 | ○ |
| 市区町村 | 正式な市区町村 | ○ |
| 番地・建物名 | 正式な番地・建物名 | ○ |
| 電話番号（正式） | 統一したい正式な電話番号 | ○ |
| FAX番号 | 正式なFAX番号 | - |
| メールアドレス | 医院のメールアドレス | - |
| 公式サイトURL | 医院の公式サイト | - |
| 営業時間 | 診療時間（テキスト形式） | - |
| 休診日 | 休診日（テキスト形式） | - |
| 備考 | 自由記述 | - |
| ステータス | 有効/無効 | ○ |
| 登録日時 | 自動記録 | - |
| 更新日時 | 自動記録 | - |

#### 3.2.2 旧NAP情報（バリエーション）
1つの医院に対して複数の旧NAP情報を登録可能。

| 項目 | 説明 |
|------|------|
| 旧医院名 | 過去に使用していた名称、表記ゆれ |
| 旧住所 | 過去の住所、表記ゆれ |
| 旧電話番号 | 過去の電話番号 |
| 備考 | この表記が使われていた理由・時期など |

**用途**: サイト上でこれらの旧情報が検出された場合、「不一致」としてアラートを出す。

#### 3.2.3 医院情報クイックコピー機能 ⚡

医院詳細画面で、各項目を**ワンクリックでクリップボードにコピー**できる。

**コピー可能項目：**
| ボタン | コピー内容 |
|--------|-----------|
| 医院名 | 医院名のみ |
| 〒住所 | 〒XXX-XXXX 都道府県市区町村番地 |
| 住所のみ | 都道府県市区町村番地（郵便番号なし） |
| 電話番号 | 電話番号のみ |
| 全NAP | 医院名\n住所\n電話番号（改行区切り） |

**表示形式：**
```
┌─────────────────────────────────────────────┐
│ 山田歯科クリニック              [コピー]    │
├─────────────────────────────────────────────┤
│ 〒150-0001                       [コピー]    │
│ 東京都渋谷区神宮前1-2-3 ABCビル5F           │
├─────────────────────────────────────────────┤
│ 03-1234-5678                     [コピー]    │
├─────────────────────────────────────────────┤
│           [全NAPをコピー]                   │
└─────────────────────────────────────────────┘
```

コピー成功時はトースト通知「コピーしました」を表示。

---

### 3.3 サイトリスト管理

各医院のNAP情報が掲載される可能性のあるサイトを管理する。

#### 3.3.1 サイト種別（3種類）

| 種別 | 説明 | 編集権限 |
|------|------|----------|
| マスタサイト | 管理者が事前登録する標準サイト | 管理者のみ |
| 自動追加 | WEB検索で自動発見されたサイト | 管理者 |
| 手動追加 | 管理者が個別に追加したサイト | 管理者 |

#### 3.3.2 サイト情報項目

| 項目 | 説明 | 必須 |
|------|------|------|
| サイト名 | サイトの名称（例: Google ビジネスプロフィール） | ○ |
| サイトURL | サイトのトップページURL | ○ |
| 新規登録URL | 医院情報を新規登録するページのURL | - |
| 修正依頼URL | 医院情報を修正依頼するページのURL | - |
| 種別① | 有料 / 無料 / 承認制 | ○ |
| 種別② | SNS / ポータルサイト / 求人サイト / その他 | ○ |
| 変更依頼方法 | フォーム / メール / 電話 / その他 | ○ |
| **重要度** | 高 / 中 / 低 | ○ |
| **SEO影響度** | 大 / 中 / 小 / なし | ○ |
| 修正依頼テンプレート | サイト別のカスタムテンプレート | - |
| コメント | 自由記述（注意事項、手順メモなど） | - |
| 有効/無効 | サイトの監視対象フラグ | ○ |
| 登録日時 | 自動記録 | - |
| 更新日時 | 自動記録 | - |

#### 3.3.3 マスタサイト一覧（初期登録）

| カテゴリ | サイト名 | 重要度 | SEO影響度 |
|----------|----------|--------|-----------|
| 検索エンジン | Google ビジネスプロフィール | 高 | 大 |
| 検索エンジン | Yahoo!プレイス | 高 | 中 |
| 地図 | Apple Maps | 中 | 小 |
| ポータル | EPARK歯科 | 高 | 大 |
| ポータル | 歯科タウン | 中 | 中 |
| ポータル | デンターネット | 中 | 中 |
| ポータル | Caloo | 中 | 中 |
| 口コミ | エキテン | 中 | 中 |
| SNS | Facebook | 中 | 小 |
| SNS | Instagram | 低 | 小 |
| SNS | LINE公式 | 中 | なし |
| 求人 | ジョブメドレー | 低 | 小 |
| 求人 | グッピー | 低 | 小 |
| 求人 | Indeed | 低 | 小 |
| 公的機関 | 日本歯科医師会 | 中 | 中 |

---

### 3.4 医院別サイト紐付け（NAP監視対象）

各医院とサイトを紐付け、NAP情報の一致状況を管理する。

#### 3.4.1 紐付け情報

| 項目 | 説明 |
|------|------|
| 医院ID | 対象医院 |
| サイトID | 対象サイト |
| 掲載ページURL | 当該医院の情報が掲載されているページのURL |
| ステータス | 一致 / 要確認 / 不一致 / 未登録 / 未チェック / アクセス不可 |
| 検出NAP | サイトから取得したNAP情報 |
| 最終チェック日時 | 最後にNAPをチェックした日時 |
| **優先度** | 緊急 / 高 / 中 / 低（自動計算 + 手動調整可） |
| 備考 | 自由記述 |

#### 3.4.2 ステータス定義

| ステータス | 説明 | 表示色 | アイコン |
|------------|------|--------|----------|
| 一致 | 正式NAPと完全一致 | 緑 | ✓ |
| 要確認 | 軽微な差異あり（表記ゆれ程度） | 黄 | ! |
| 不一致 | 明確な不一致（旧情報等） | 赤 | ✗ |
| 未登録 | サイトに医院情報が登録されていない | 青 | + |
| 未チェック | まだチェックしていない | グレー | ? |
| アクセス不可 | ページにアクセスできない | 黒 | ⚠ |

#### 3.4.3 優先度の自動計算ロジック

```
優先度スコア = サイト重要度 × SEO影響度 × ステータス緊急度

ステータス緊急度:
- 不一致: 3
- 要確認: 2
- 未登録: 1.5
- 未チェック: 1
- 一致: 0
- アクセス不可: 0.5

重要度・影響度:
- 高/大: 3
- 中: 2
- 低/小: 1
- なし: 0
```

---

### 3.5 効率化機能 ⚡

#### 3.5.1 ワークスペース（メイン作業画面）

医院を選択すると、その医院の全サイト状況を**1画面で確認・操作**できる。

**レイアウト:**
```
┌─────────────────────────────────────────────────────────────────┐
│ [医院選択ドロップダウン ▼]              [全NAP コピー] [設定]  │
├─────────────────────────────────────────────────────────────────┤
│ 山田歯科クリニック                                              │
│ 〒150-0001 東京都渋谷区神宮前1-2-3 / 03-1234-5678              │
│ 統一率: ████████░░ 80% (16/20サイト)                           │
├─────────────────────────────────────────────────────────────────┤
│ フィルタ: [全て▼] [ステータス▼] [種別▼] [優先度▼] [🔍検索]    │
├─────────────────────────────────────────────────────────────────┤
│ □ サイト名          ステータス   優先度  最終確認   アクション  │
├─────────────────────────────────────────────────────────────────┤
│ ☑ Google ビジネス   🔴不一致    緊急    12/20     [▶][✎][📋]  │
│ ☑ EPARK歯科         🟡要確認    高      12/18     [▶][✎][📋]  │
│ □ Yahoo!プレイス    🟢一致      -       12/15     [▶][✎]      │
│ □ 歯科タウン        🔵未登録    中      -         [▶][+]      │
│ ☑ Facebook          🟡要確認    中      12/10     [▶][✎][📋]  │
├─────────────────────────────────────────────────────────────────┤
│ 選択: 3件  [一括ステータス変更▼] [一括で修正依頼作成]          │
└─────────────────────────────────────────────────────────────────┘

アクションボタン:
[▶] = サイトを開く（掲載ページURL）
[✎] = 詳細編集（サイドパネル）
[📋] = 修正依頼文をコピー
[+] = 新規登録ページを開く
```

#### 3.5.2 クイックアクションボタン

各サイト行に以下のボタンを配置：

| ボタン | 機能 | 動作 |
|--------|------|------|
| サイトを開く | 掲載ページURLを新規タブで開く | 外部リンク |
| 編集 | サイドパネルで詳細編集 | パネル表示 |
| 依頼文コピー | 修正依頼テンプレートをクリップボードへ | コピー+トースト |
| 新規登録 | 新規登録URLを新規タブで開く | 外部リンク |
| 修正ページ | 修正依頼URLを新規タブで開く | 外部リンク |

#### 3.5.3 サイドパネル編集

行をクリックすると、画面右側にサイドパネルが表示される。ページ遷移なしで詳細確認・編集が可能。

**サイドパネル構成:**
```
┌─────────────────────────────┐
│ Google ビジネスプロフィール  │
│ ステータス: [不一致 ▼]      │
├─────────────────────────────┤
│ ■ 正式NAP（コピー可）       │
│ 山田歯科クリニック   [📋]   │
│ 東京都渋谷区...       [📋]   │
│ 03-1234-5678         [📋]   │
├─────────────────────────────┤
│ ■ 検出NAP（現在の掲載）     │
│ 山田歯科医院                │
│ 渋谷区神宮前1-2-3           │
│ 03-1234-5678                │
├─────────────────────────────┤
│ ■ 差分ハイライト            │
│ 名前: 山田歯科[クリニック]  │
│       ↳ [医院] ❌            │
├─────────────────────────────┤
│ [サイトを開く] [修正ページ] │
├─────────────────────────────┤
│ ■ 修正依頼                  │
│ [テンプレート生成]          │
│ [依頼文をコピー]            │
│ [依頼済みにする]            │
├─────────────────────────────┤
│ ■ 対応履歴                  │
│ 12/20 依頼済み              │
│ 12/15 不一致検出            │
├─────────────────────────────┤
│ メモ: [________________]    │
│                             │
│        [保存] [閉じる]      │
└─────────────────────────────┘
```

#### 3.5.4 一括操作機能

**一括ステータス変更:**
- チェックボックスで複数選択
- ドロップダウンで新ステータスを選択
- 「適用」で一括変更

**一括修正依頼作成:**
- チェックボックスで複数選択
- 「一括で修正依頼作成」ボタン
- 各サイトの修正依頼レコードを一括生成
- 一覧形式で依頼文を表示（各コピー可能）

#### 3.5.5 NAPコピーパレット

画面上部に常時表示される、正式NAP情報のコピー用パレット。

```
┌────────────────────────────────────────────────────────────┐
│ 📋 山田歯科クリニック [コピー]                             │
│ 📋 〒150-0001 東京都渋谷区神宮前1-2-3 ABCビル5F [コピー]   │
│ 📋 03-1234-5678 [コピー]                                   │
│ [全てコピー] [住所のみ] [電話のみ]                         │
└────────────────────────────────────────────────────────────┘
```

折りたたみ可能。展開時は常に画面上部に固定表示。

---

### 3.6 修正依頼管理

#### 3.6.1 修正依頼テンプレート

**デフォルトテンプレート:**
```
件名: 【情報修正のお願い】{{医院名}}の掲載情報について

{{サイト名}} 運営者様

お世話になっております。
{{医院名}}の情報掲載についてご連絡いたします。

現在、貴サイトに掲載されている当院の情報に誤りがございますので、
下記の通り修正をお願いいたします。

【現在の掲載内容】
医院名: {{検出医院名}}
住所: {{検出住所}}
電話番号: {{検出電話番号}}

【正しい情報】
医院名: {{正式医院名}}
住所: {{正式住所}}
電話番号: {{正式電話番号}}

お手数をおかけいたしますが、ご対応のほどよろしくお願いいたします。

{{医院名}}
{{正式電話番号}}
```

**変数一覧:**
| 変数 | 内容 |
|------|------|
| `{{医院名}}` | 正式医院名 |
| `{{正式医院名}}` | 正式医院名 |
| `{{正式住所}}` | 郵便番号 + 住所 |
| `{{正式電話番号}}` | 正式電話番号 |
| `{{検出医院名}}` | サイトで検出された医院名 |
| `{{検出住所}}` | サイトで検出された住所 |
| `{{検出電話番号}}` | サイトで検出された電話番号 |
| `{{サイト名}}` | サイト名 |
| `{{掲載ページURL}}` | 掲載ページのURL |
| `{{今日の日付}}` | YYYY年MM月DD日形式 |

**サイト別カスタムテンプレート:**
サイトごとにカスタムテンプレートを登録可能。登録がない場合はデフォルトを使用。

#### 3.6.2 対応状況トラッキング

| ステータス | 説明 | 色 |
|------------|------|-----|
| 未対応 | 修正依頼を送信していない | グレー |
| 依頼済み | 修正依頼を送信した | 青 |
| 対応中 | 先方で対応中（連絡あり） | 黄 |
| 完了 | 修正が完了し確認済み | 緑 |
| 対応不可 | 先方の都合で対応できない | 赤 |
| 保留 | 一時的に対応を保留 | グレー |

#### 3.6.3 リマインダー機能

- 依頼後N日経過でリマインド（デフォルト: 7日）
- ダッシュボードに「要フォローアップ」として表示
- メール通知（設定可能）

#### 3.6.4 修正依頼履歴
- 依頼日時
- 依頼方法（フォーム/メール/電話）
- 担当者メモ
- 添付ファイル（スクリーンショット等）
- ステータス変更履歴

---

### 3.7 ダッシュボード

#### 3.7.1 全体サマリー

```
┌─────────────────────────────────────────────────────────────┐
│                    デンタルNAPマネージャー                  │
├─────────────────────────────────────────────────────────────┤
│  管理医院数        NAP統一率        要対応         完了待ち │
│    12院            78.5%           23件            8件     │
│                   ████████░░                               │
├─────────────────────────────────────────────────────────────┤
│  📊 ステータス別内訳                                        │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 🟢一致: 156  🟡要確認: 12  🔴不一致: 8  🔵未登録: 15 │    │
│  │ ⚪未チェック: 9  ⚫アクセス不可: 2                   │    │
│  └────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  🔥 優先対応（上位5件）                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 山田歯科 × Google ビジネス     🔴不一致 [対応→]  │   │
│  │ 2. 鈴木デンタル × EPARK           🔴不一致 [対応→]  │   │
│  │ 3. 山田歯科 × Yahoo!プレイス      🟡要確認 [対応→]  │   │
│  │ 4. 田中歯科 × Google ビジネス     🔵未登録 [対応→]  │   │
│  │ 5. 佐藤歯科医院 × 歯科タウン      🟡要確認 [対応→]  │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  ⏰ フォローアップ待ち                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 山田歯科 × EPARK - 依頼から7日経過 [確認→]        │   │
│  │ • 鈴木デンタル × Facebook - 依頼から14日経過 [確認→]│   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  📈 医院別統一率                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 山田歯科クリニック   ████████░░ 85%                  │   │
│  │ 鈴木デンタルオフィス ███████░░░ 70%                  │   │
│  │ 田中歯科医院         ██████░░░░ 60%                  │   │
│  │ ...                                                  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 3.7.2 クイックアクセス

- 「優先対応」セクションから直接ワークスペースへ遷移
- ワンクリックで該当医院・サイトの編集パネルを開く

---

### 3.8 一括データ管理

#### 3.8.1 CSVインポート

**医院一括登録:**
```csv
医院名,医院名かな,郵便番号,都道府県,市区町村,番地建物,電話番号,FAX,メール,公式サイト
山田歯科クリニック,やまだしかくりにっく,150-0001,東京都,渋谷区,神宮前1-2-3 ABCビル5F,03-1234-5678,03-1234-5679,info@yamada-dental.jp,https://yamada-dental.jp
```

**サイト紐付け一括登録:**
```csv
医院名,サイト名,掲載ページURL,ステータス
山田歯科クリニック,Google ビジネスプロフィール,https://maps.google.com/...,一致
山田歯科クリニック,EPARK歯科,https://epark.jp/...,不一致
```

#### 3.8.2 CSVエクスポート

**出力可能なレポート:**
- 医院一覧
- サイト紐付け一覧（全件）
- 不一致・要確認のみ抽出
- 修正依頼進捗一覧

#### 3.8.3 一括サイト紐付け

新規医院登録時に、マスタサイト全件を自動で紐付ける機能。
- 登録時に「マスタサイトを自動紐付け」チェックボックス
- 紐付け時は全て「未チェック」ステータス

---

### 3.9 キーボードショートカット

| ショートカット | 機能 |
|----------------|------|
| `j` / `k` | 次/前の行を選択 |
| `Enter` | 選択行の詳細パネルを開く |
| `Escape` | パネルを閉じる |
| `c` | 選択行の修正依頼文をコピー |
| `o` | 選択行のサイトを開く |
| `Space` | 選択行のチェックON/OFF |
| `/` | 検索フィールドにフォーカス |
| `?` | ショートカット一覧を表示 |

---

### 3.10 通知・アラート

#### 3.10.1 ダッシュボード通知
- 不一致件数をバッジで表示
- 要フォローアップをバナーで表示

#### 3.10.2 メール通知

| 通知タイプ | タイミング | デフォルト |
|------------|-----------|------------|
| 新規不一致検出 | 即時 | ON |
| 週次サマリー | 毎週月曜9:00 | ON |
| フォローアップリマインド | 依頼後7日 | ON |
| アクセス不可検出 | 即時 | OFF |

#### 3.10.3 通知設定
管理者ごとに各通知のON/OFFを設定可能。

---

## 4. 画面一覧

### 4.1 認証系画面

| 画面名 | パス | 説明 |
|--------|------|------|
| ログイン | /login | 管理者ログイン |
| パスワードリセット | /password-reset | パスワード再設定 |
| パスワード再設定 | /password-reset/:token | 新パスワード入力 |

### 4.2 メイン画面

| 画面名 | パス | 説明 |
|--------|------|------|
| ダッシュボード | /dashboard | 全体サマリー、優先対応、フォローアップ |
| ワークスペース | /workspace | 医院選択式の統合作業画面 |
| ワークスペース（医院指定） | /workspace/:clinicId | 特定医院のワークスペース |
| 医院一覧 | /clinics | 登録医院の一覧・検索 |
| 医院登録 | /clinics/new | 新規医院登録 |
| 医院編集 | /clinics/:id/edit | 医院情報編集 |
| サイト一覧 | /sites | マスタサイト一覧 |
| サイト登録 | /sites/new | 新規サイト登録 |
| サイト編集 | /sites/:id/edit | サイト情報編集 |
| 修正依頼一覧 | /requests | 修正依頼の一覧・フィルタリング |
| インポート | /import | CSV一括インポート |
| エクスポート | /export | CSV一括エクスポート |
| 設定 | /settings | 通知設定、テンプレート管理、アカウント設定 |

---

## 5. データモデル

### 5.1 ER図（概念）

```
┌─────────────┐       ┌─────────────────┐
│   admins    │       │     clinics     │
├─────────────┤       ├─────────────────┤
│ id          │       │ id              │
│ email       │       │ name            │
│ password    │       │ name_kana       │
│ name        │       │ postal_code     │
│ created_at  │       │ prefecture      │
│ updated_at  │       │ city            │
└─────────────┘       │ address         │
                      │ phone           │
                      │ fax             │
                      │ email           │
                      │ website         │
                      │ business_hours  │
                      │ closed_days     │
                      │ notes           │
                      │ is_active       │
                      │ created_at      │
                      │ updated_at      │
                      └────────┬────────┘
                               │
                               │ 1:N
                               ▼
                      ┌─────────────────┐
                      │   clinic_naps   │
                      │  (旧NAP情報)    │
                      ├─────────────────┤
                      │ id              │
                      │ clinic_id       │
                      │ old_name        │
                      │ old_address     │
                      │ old_phone       │
                      │ notes           │
                      │ created_at      │
                      └─────────────────┘

┌─────────────────┐
│     sites       │
├─────────────────┤
│ id              │
│ name            │
│ url             │
│ register_url    │
│ edit_url        │
│ type_1          │  (有料/無料/承認制)
│ type_2          │  (SNS/ポータル/求人/他)
│ edit_method     │  (フォーム/メール/電話/他)
│ importance      │  (高/中/低)
│ seo_impact      │  (大/中/小/なし)
│ template        │  (カスタムテンプレート)
│ comment         │
│ site_type       │  (master/auto/manual)
│ is_active       │
│ created_at      │
│ updated_at      │
└────────┬────────┘
         │
         │ N:M (through clinic_sites)
         ▼
┌─────────────────────┐
│    clinic_sites     │
│  (医院別紐付け)     │
├─────────────────────┤
│ id                  │
│ clinic_id           │
│ site_id             │
│ page_url            │
│ status              │
│ priority            │  (緊急/高/中/低)
│ priority_score      │  (自動計算スコア)
│ detected_name       │
│ detected_address    │
│ detected_phone      │
│ last_checked_at     │
│ notes               │
│ created_at          │
│ updated_at          │
└──────────┬──────────┘
           │
           │ 1:N
           ▼
┌─────────────────────┐
│ correction_requests │
│    (修正依頼)       │
├─────────────────────┤
│ id                  │
│ clinic_site_id      │
│ status              │
│ request_method      │
│ template_text       │
│ requested_at        │
│ reminder_at         │
│ notes               │
│ created_at          │
│ updated_at          │
└──────────┬──────────┘
           │
           │ 1:N
           ▼
┌─────────────────────┐
│  request_histories  │
│    (依頼履歴)       │
├─────────────────────┤
│ id                  │
│ correction_id       │
│ action              │
│ notes               │
│ attachment_url      │
│ created_at          │
└─────────────────────┘

┌─────────────────────┐
│notification_settings│
│    (通知設定)       │
├─────────────────────┤
│ id                  │
│ admin_id            │
│ new_mismatch        │
│ weekly_summary      │
│ follow_up_reminder  │
│ access_error        │
│ reminder_days       │
│ created_at          │
│ updated_at          │
└─────────────────────┘

┌─────────────────────┐
│   email_templates   │
│(メールテンプレート) │
├─────────────────────┤
│ id                  │
│ name                │
│ subject             │
│ body                │
│ is_default          │
│ created_at          │
│ updated_at          │
└─────────────────────┘
```

### 5.2 テーブル定義

#### 5.2.1 admins（管理者）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| email | VARCHAR(255) | メールアドレス（ユニーク） |
| password_hash | VARCHAR(255) | パスワードハッシュ |
| name | VARCHAR(100) | 管理者名 |
| failed_login_attempts | INTEGER | ログイン失敗回数 |
| locked_until | TIMESTAMP | ロック解除日時 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.2 clinics（医院）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(200) | 正式医院名 |
| name_kana | VARCHAR(200) | 医院名かな |
| postal_code | VARCHAR(10) | 郵便番号 |
| prefecture | VARCHAR(10) | 都道府県 |
| city | VARCHAR(50) | 市区町村 |
| address | VARCHAR(200) | 番地・建物名 |
| phone | VARCHAR(20) | 正式電話番号 |
| fax | VARCHAR(20) | FAX番号 |
| email | VARCHAR(255) | メールアドレス |
| website | VARCHAR(500) | 公式サイトURL |
| business_hours | TEXT | 営業時間 |
| closed_days | TEXT | 休診日 |
| notes | TEXT | 備考 |
| is_active | BOOLEAN | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.3 clinic_naps（旧NAP情報）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | 医院ID（外部キー） |
| old_name | VARCHAR(200) | 旧医院名 |
| old_address | VARCHAR(500) | 旧住所 |
| old_phone | VARCHAR(20) | 旧電話番号 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |

#### 5.2.4 sites（サイト）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(200) | サイト名 |
| url | VARCHAR(500) | サイトURL |
| register_url | VARCHAR(500) | 新規登録URL |
| edit_url | VARCHAR(500) | 修正依頼URL |
| type_1 | ENUM('paid','free','approval') | 有料/無料/承認制 |
| type_2 | ENUM('sns','portal','job','other') | SNS/ポータル/求人/その他 |
| edit_method | ENUM('form','email','phone','other') | 変更依頼方法 |
| importance | ENUM('high','medium','low') | 重要度 |
| seo_impact | ENUM('large','medium','small','none') | SEO影響度 |
| template | TEXT | カスタム修正依頼テンプレート |
| comment | TEXT | コメント |
| site_type | ENUM('master','auto','manual') | サイト種別 |
| is_active | BOOLEAN | 有効フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.5 clinic_sites（医院別サイト紐付け）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | 医院ID（外部キー） |
| site_id | UUID | サイトID（外部キー） |
| page_url | VARCHAR(500) | 掲載ページURL |
| status | ENUM | 一致/要確認/不一致/未登録/未チェック/アクセス不可 |
| priority | ENUM('urgent','high','medium','low') | 優先度 |
| priority_score | INTEGER | 優先度スコア（自動計算） |
| detected_name | VARCHAR(200) | 検出された医院名 |
| detected_address | VARCHAR(500) | 検出された住所 |
| detected_phone | VARCHAR(20) | 検出された電話番号 |
| last_checked_at | TIMESTAMP | 最終チェック日時 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.6 correction_requests（修正依頼）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_site_id | UUID | 医院サイト紐付けID（外部キー） |
| status | ENUM | 未対応/依頼済み/対応中/完了/対応不可/保留 |
| request_method | ENUM('form','email','phone','other') | 依頼方法 |
| template_text | TEXT | 依頼テンプレート文 |
| requested_at | TIMESTAMP | 依頼日時 |
| reminder_at | TIMESTAMP | 次回リマインド日時 |
| notes | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.7 request_histories（依頼履歴）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| correction_request_id | UUID | 修正依頼ID（外部キー） |
| action | VARCHAR(100) | アクション内容 |
| notes | TEXT | メモ |
| attachment_url | VARCHAR(500) | 添付ファイルURL |
| created_at | TIMESTAMP | 作成日時 |

#### 5.2.8 notification_settings（通知設定）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| admin_id | UUID | 管理者ID（外部キー） |
| new_mismatch | BOOLEAN | 新規不一致通知 |
| weekly_summary | BOOLEAN | 週次サマリー |
| follow_up_reminder | BOOLEAN | フォローアップリマインド |
| access_error | BOOLEAN | アクセス不可通知 |
| reminder_days | INTEGER | リマインド日数（デフォルト7） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### 5.2.9 email_templates（メールテンプレート）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR(100) | テンプレート名 |
| subject | VARCHAR(200) | 件名テンプレート |
| body | TEXT | 本文テンプレート |
| is_default | BOOLEAN | デフォルトフラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

---

## 6. 技術スタック

### 6.1 フロントエンド
| 技術 | 用途 |
|------|------|
| Next.js 14 (App Router) | Reactフレームワーク |
| TypeScript | 型安全な開発 |
| Tailwind CSS | スタイリング |
| shadcn/ui | UIコンポーネント |
| React Hook Form | フォーム管理 |
| Zod | バリデーション |
| TanStack Query | データフェッチング・キャッシュ |
| TanStack Table | テーブル・ソート・フィルタ |
| Sonner | トースト通知 |
| cmdk | コマンドパレット |

### 6.2 バックエンド
| 技術 | 用途 |
|------|------|
| Next.js API Routes (App Router) | APIエンドポイント |
| Prisma | ORM |
| PostgreSQL | データベース |
| NextAuth.js v5 | 認証 |
| Resend | メール送信 |
| Zod | サーバーサイドバリデーション |

### 6.3 インフラ
| 技術 | 用途 |
|------|------|
| Vercel | ホスティング |
| Supabase | PostgreSQL |
| Cloudflare R2 | ファイルストレージ |
| Vercel Cron | 定期処理（週次サマリー等） |

---

## 7. 非機能要件

### 7.1 セキュリティ
- HTTPS必須
- パスワードはbcryptでハッシュ化
- SQLインジェクション対策（Prisma使用）
- XSS対策（React + CSP）
- CSRF対策（NextAuth.js）

### 7.2 パフォーマンス
- ページ読み込み: 2秒以内
- API応答: 300ms以内
- テーブル描画: 1000行でも滑らかに動作

### 7.3 可用性
- 稼働率: 99.5%以上
- データバックアップ: 日次

### 7.4 ブラウザ対応
- Chrome（最新2バージョン）
- Firefox（最新2バージョン）
- Safari（最新2バージョン）
- Edge（最新2バージョン）

### 7.5 アクセシビリティ
- キーボード操作対応
- スクリーンリーダー対応（ARIA）
- 十分なコントラスト比

---

## 8. 今後の拡張候補

以下は本フェーズでは対象外だが、将来的に検討する機能：

1. **NAP自動チェック機能** - 定期的にサイトをクロールしてNAP情報を自動取得・比較
2. **WEB検索による自動サイト発見** - 医院名で検索して掲載サイトを自動発見
3. **API連携** - Google ビジネスプロフィールAPI等との連携
4. **レポート機能** - PDF形式でのNAP統一状況レポート出力
5. **複数管理者対応** - 権限レベルを持つ複数管理者
6. **Slack/Teams通知** - チャットツールへの通知連携
7. **スクリーンショット自動取得** - 掲載ページのスクリーンショットを自動保存

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| NAP | Name, Address, Phone の略。事業者の基本情報 |
| 正式NAP | 統一すべき正しいNAP情報 |
| 旧NAP | 過去に使用していたNAP情報、表記ゆれ |
| マスタサイト | 管理者が事前登録する標準的な監視対象サイト |
| 不一致 | サイト上のNAPが正式NAPと異なる状態 |
| 表記ゆれ | 同じ情報の異なる表記（例: 「1丁目」と「1-」） |
| ワークスペース | 医院単位でNAP統一作業を行う統合画面 |
| 優先度スコア | サイト重要度とステータスから自動計算される対応優先度 |

---

## 10. 改訂履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 0.1 | 2025-12-25 | 初版作成 |
| 0.2 | 2025-12-25 | 効率化機能を大幅追加（ワークスペース、クイックアクション、一括操作、キーボードショートカット等） |
